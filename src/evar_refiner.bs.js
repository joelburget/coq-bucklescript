// Generated by BUCKLESCRIPT VERSION 2.2.2, PLEASE EDIT WITH CARE
'use strict';

var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Js_exn = require("bs-platform/lib/js/js_exn.js");
var Pp$ReactTemplate = require("./pp.bs.js");
var Evd$ReactTemplate = require("./evd.bs.js");
var Evar$ReactTemplate = require("./evar.bs.js");
var Util$ReactTemplate = require("./util.bs.js");
var Names$ReactTemplate = require("./names.bs.js");
var CErrors$ReactTemplate = require("./cErrors.bs.js");
var EConstr$ReactTemplate = require("./eConstr.bs.js");
var Termops$ReactTemplate = require("./termops.bs.js");
var Evarconv$ReactTemplate = require("./evarconv.bs.js");
var Evarutil$ReactTemplate = require("./evarutil.bs.js");
var Glob_ops$ReactTemplate = require("./glob_ops.bs.js");
var Pretyping$ReactTemplate = require("./pretyping.bs.js");
var Pretype_errors$ReactTemplate = require("./pretype_errors.bs.js");

function w_refine(param, param$1, sigma) {
  var rawc = param$1[1];
  var evi = param[1];
  var evk = param[0];
  if (Evd$ReactTemplate.is_defined(sigma, evk)) {
    CErrors$ReactTemplate.user_err(/* None */0, /* None */0, Pp$ReactTemplate.str("Instantiate called on already-defined evar"));
  }
  var env = Evd$ReactTemplate.evar_filtered_env(evi);
  var match;
  try {
    match = Pretyping$ReactTemplate.understand_ltac(/* record */[
          /* use_typeclasses : true */1,
          /* solve_unification_constraints : true */1,
          /* use_hook : None */0,
          /* fail_evar : false */0,
          /* expand_evars : true */1
        ], env, sigma, param$1[0], /* OfType */[EConstr$ReactTemplate.of_constr(evi[/* evar_concl */0])], rawc);
  }
  catch (raw_e){
    var e = Js_exn.internalToOCamlException(raw_e);
    if (CErrors$ReactTemplate.noncritical(e)) {
      var loc = Glob_ops$ReactTemplate.loc_of_glob_constr(rawc);
      match = CErrors$ReactTemplate.user_err(loc, /* None */0, Pp$ReactTemplate.$plus$plus(Pp$ReactTemplate.$plus$plus(Pp$ReactTemplate.str("Instance is not well-typed in the environment of "), Termops$ReactTemplate.pr_existential_key(sigma, evk)), Pp$ReactTemplate.str(".")));
    } else {
      throw e;
    }
  }
  var evk$1 = evk;
  var c = match[1];
  var env$1 = env;
  var evd = Evd$ReactTemplate.evars_reset_evd(/* None */0, /* None */0, match[0], sigma);
  if (Termops$ReactTemplate.occur_evar(evd, evk$1, c)) {
    Pretype_errors$ReactTemplate.error_occur_check(env$1, evd, evk$1, c);
  }
  var evd$1 = Evd$ReactTemplate.define(evk$1, EConstr$ReactTemplate.Unsafe[/* to_constr */0](c), evd);
  var match$1 = Evd$ReactTemplate.extract_changed_conv_pbs(evd$1, (function (param, param$1) {
          var sigma = evd$1;
          var evk$2 = evk$1;
          var param$2 = param$1;
          var t1 = EConstr$ReactTemplate.of_constr(param$2[2]);
          var t2 = EConstr$ReactTemplate.of_constr(param$2[3]);
          try {
            return Evar$ReactTemplate.equal(Evarutil$ReactTemplate.head_evar(sigma, t1), evk$2);
          }
          catch (exn){
            if (exn === Evarutil$ReactTemplate.NoHeadEvar) {
              try {
                return Evar$ReactTemplate.equal(Evarutil$ReactTemplate.head_evar(sigma, t2), evk$2);
              }
              catch (exn$1){
                if (exn$1 === Evarutil$ReactTemplate.NoHeadEvar) {
                  return /* false */0;
                } else {
                  throw exn$1;
                }
              }
            } else {
              throw exn;
            }
          }
        }));
  var match$2 = Curry._3(Util$ReactTemplate.List[/* fold_left */13], (function (p, param) {
          if (p.tag) {
            return p;
          } else {
            return Curry._5(Evarconv$ReactTemplate.evar_conv_x(Names$ReactTemplate.full_transparent_state), param[1], p[0], param[0], EConstr$ReactTemplate.of_constr(param[2]), EConstr$ReactTemplate.of_constr(param[3]));
          }
        }), /* Success */Block.__(0, [match$1[0]]), match$1[1]);
  if (match$2.tag) {
    return CErrors$ReactTemplate.user_err(/* None */0, /* None */0, Pp$ReactTemplate.str("Instance does not satisfy the constraints."));
  } else {
    return match$2[0];
  }
}

exports.w_refine = w_refine;
/* Pp-ReactTemplate Not a pure module */
